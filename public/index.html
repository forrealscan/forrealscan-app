<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ForRealScan ‚Äì Veritas & Robo</title>

  <!-- Favicon (wichtig: kein /api/i) -->
  <link rel="icon" type="image/png" href="/mascots/Veritas.png" />
  <link rel="apple-touch-icon" href="/mascots/Veritas.png" />
  <link rel="shortcut icon" href="/mascots/Veritas.png" />

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Arial, sans-serif;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 40px 10px;
      background: radial-gradient(circle at top, #f0f4ff, #0a1d30);
      color: #f8fafc;
      transition: background 0.6s ease;
    }

    /* Hintergrund je nach Ergebnis */
    body.theme-veritas {
      background: radial-gradient(circle at top, #f2fff0, #0d3120);
    }

    body.theme-robo {
      background: radial-gradient(circle at top, #021533, #020617);
    }

    h1 {
      margin: 0 0 4px;
      font-size: 32px;
      text-align: center;
    }

    p.subtitle {
      margin: 0 0 26px;
      text-align: center;
      color: #cbd5f5;
      font-size: 14px;
    }

    #box {
      width: 100%;
      max-width: 960px;
      background: rgba(9, 17, 34, 0.96);
      border-radius: 18px;
      padding: 22px 18px 28px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.45);
    }

    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
    }

    #fileInput {
      padding: 12px;
      font-size: 16px;
      border-radius: 10px;
      background: #ffffff;
      border: none;
      cursor: pointer;
      max-width: 260px;
    }

    #apiVersion {
      padding: 12px 14px;
      font-size: 15px;
      border-radius: 10px;
      border: none;
      background: #ffffff;
      cursor: pointer;
    }

    #scanBtn {
      padding: 14px 32px;
      font-size: 16px;
      border-radius: 999px;
      background: #1a8f3e;
      color: white;
      border: none;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(16, 185, 129, 0.35);
      transition: background 0.18s ease, transform 0.12s ease,
        box-shadow 0.18s ease;
      font-weight: 600;
    }

    #scanBtn:hover {
      background: #22c55e;
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(34, 197, 94, 0.45);
    }

    #scanBtn:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 4px 14px rgba(16, 185, 129, 0.35);
    }

    #scanBtn.loading {
      opacity: 0.7;
      cursor: wait;
      transform: none;
      box-shadow: none;
    }

    #preview {
      display: none;
      width: 100%;
      max-height: 480px;
      object-fit: contain;
      border-radius: 14px;
      margin-top: 16px;
      background: #020617;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
    }

    /* Maskottchen & Ergebnisbereich */

    #mascotSection {
      margin-top: 26px;
      text-align: center;
    }

    #mascotImage {
      width: 140px;
      height: 140px;
      object-fit: contain;
      border-radius: 24px;
      background: #020617;
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.75);
      padding: 6px;
    }

    #mascotLabel {
      margin-top: 10px;
      font-weight: 700;
    }

    #mascotLabel span {
      font-weight: 400;
      opacity: 0.9;
    }

    /* Fortschrittsbalken */

    .progress-wrapper {
      margin: 22px auto 8px;
      max-width: 460px;
      text-align: left;
    }

    #progressBarTrack {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: #0f172a;
      overflow: hidden;
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.7);
    }

    #progressBarFill {
      height: 100%;
      width: 0%;
      border-radius: inherit;
      background: linear-gradient(90deg, #22c55e, #3b82f6);
      transition: width 0.6s ease;
    }

    #progressBarFill.loading {
      width: 30%;
      animation: progressPulse 1s ease-in-out infinite;
    }

    @keyframes progressPulse {
      0% {
        transform: translateX(-40%);
      }
      50% {
        transform: translateX(0%);
      }
      100% {
        transform: translateX(40%);
      }
    }

    #scoreText {
      margin-top: 8px;
      font-size: 15px;
      font-weight: 600;
      text-align: center;
    }

    #statusMessage {
      margin-top: 4px;
      font-size: 13px;
      text-align: center;
      color: #cbd5f5;
    }

    #statusMessage.error {
      color: #f97373;
      font-weight: 600;
    }

    #result {
      margin-top: 18px;
      font-size: 14px;
      line-height: 1.6;
      color: #e5e7eb;
    }

    #result ul {
      padding-left: 20px;
    }

    #result li {
      margin-bottom: 4px;
    }

    @media (max-width: 768px) {
      body {
        padding: 20px 8px;
      }

      h1 {
        font-size: 26px;
      }

      #box {
        padding: 18px 14px 22px;
        border-radius: 16px;
      }

      #preview {
        max-height: 340px;
      }

      #controls {
        flex-direction: column;
        align-items: stretch;
      }

      #fileInput,
      #apiVersion,
      #scanBtn {
        width: 100%;
      }

      #scanBtn {
        justify-content: center;
        display: inline-flex;
      }
    }
  </style>
</head>
<body class="theme-robo">
  <div>
    <h1>ForRealScan</h1>
    <p class="subtitle">Mit Veritas &amp; Robo ‚Äì KI-Check f√ºr deine Bilder</p>

    <div id="box">
      <div id="controls">
        <input id="fileInput" type="file" accept="image/*" />

        <!-- V2 ist Standard; V3 optional ausw√§hlbar -->
        <select id="apiVersion">
          <option value="v2" selected>API-Version 2 (Standard)</option>
          <option value="v3">API-Version 3 (Test)</option>
        </select>

        <button id="scanBtn">üîç Test starten</button>
      </div>

      <img id="preview" alt="Bildvorschau" />

      <div id="mascotSection">
        <img
          id="mascotImage"
          src="/mascots/Veritas.png"
          alt="Veritas & Robo Maskottchen"
        />
        <div id="mascotLabel">
          <div id="mascotName">Veritas sagt:</div>
          <div><span id="mascotSubtitle">Analyse bereit.</span></div>
        </div>
      </div>

      <div class="progress-wrapper">
        <div id="progressBarTrack">
          <div id="progressBarFill"></div>
        </div>
        <div id="scoreText">KI-Wahrscheinlichkeit: ‚Äì</div>
        <div id="statusMessage">Bitte ein Bild ausw√§hlen und Analyse starten.</div>
      </div>

      <div id="result"></div>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const previewImg = document.getElementById("preview");
    const scanBtn = document.getElementById("scanBtn");
    const apiSelect = document.getElementById("apiVersion");

    const mascotImg = document.getElementById("mascotImage");
    const mascotName = document.getElementById("mascotName");
    const mascotSubtitle = document.getElementById("mascotSubtitle");

    const progressFill = document.getElementById("progressBarFill");
    const scoreText = document.getElementById("scoreText");
    const statusMessage = document.getElementById("statusMessage");
    const resultDiv = document.getElementById("result");

    let currentScore = 0;

    function setThemeForScore(score) {
      const body = document.body;
      if (score < 50) {
        body.classList.remove("theme-robo");
        body.classList.add("theme-veritas");
        mascotImg.src = "/mascots/Veritas.png";
        mascotName.textContent = "Veritas sagt:";
      } else {
        body.classList.remove("theme-veritas");
        body.classList.add("theme-robo");
        mascotImg.src = "/mascots/Robo.png";
        mascotName.textContent = "Robo erkl√§rt:";
      }
    }

    function setLoadingState(isLoading) {
      if (isLoading) {
        scanBtn.classList.add("loading");
        scanBtn.textContent = "‚è≥ Analysiere ‚Ä¶";
        statusMessage.textContent = "Veritas & Robo analysieren dein Bild ‚Ä¶";
        statusMessage.classList.remove("error");
        progressFill.classList.add("loading");
        progressFill.style.width = "30%";
        resultDiv.innerHTML = "";
      } else {
        scanBtn.classList.remove("loading");
        scanBtn.textContent = "üîç Test starten";
        progressFill.classList.remove("loading");
      }
      scanBtn.disabled = isLoading;
      fileInput.disabled = isLoading;
      apiSelect.disabled = isLoading;
    }

    fileInput.addEventListener("change", () => {
      if (!fileInput.files.length) {
        previewImg.style.display = "none";
        return;
      }
      const file = fileInput.files[0];
      const url = URL.createObjectURL(file);
      previewImg.src = url;
      previewImg.style.display = "block";
      statusMessage.textContent = "Bereit zur Analyse. Klicke auf ‚ÄûTest starten‚Äú.";
      statusMessage.classList.remove("error");
    });

    scanBtn.addEventListener("click", () => {
      if (!fileInput.files.length) {
        statusMessage.textContent = "Bitte zuerst ein Bild ausw√§hlen.";
        statusMessage.classList.add("error");
        return;
      }

      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onloadend = async () => {
        const base64 = reader.result.split(",")[1];
        if (!base64) {
          statusMessage.textContent = "Fehler: Bild konnte nicht gelesen werden.";
          statusMessage.classList.add("error");
          return;
        }

        setLoadingState(true);

        const apiVersion = apiSelect.value || "v2";
        const route =
          apiVersion === "v3" ? "/api/analyze_v3" : "/api/analyze_v2";

        try {
          const response = await fetch(route, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ imageBase64: base64 }),
          });

          const data = await response.json();

          if (!response.ok) {
            const msg = data.error || "Unbekannter Fehler von der API.";
            statusMessage.textContent = "Fehler: " + msg;
            statusMessage.classList.add("error");
            scoreText.textContent = "KI-Wahrscheinlichkeit: ‚Äì";
            progressFill.style.width = "0%";
            return;
          }

          let score = Number(data.score);
          if (!Number.isFinite(score)) score = 50;
          score = Math.min(100, Math.max(0, Math.round(score)));
          currentScore = score;

          // Theme + Maskottchen
          setThemeForScore(score);

          // Fortschrittsbalken
          progressFill.classList.remove("loading");
          progressFill.style.width = score + "%";
          scoreText.textContent = "KI-Wahrscheinlichkeit: " + score + "%";

          statusMessage.textContent = "Analyse abgeschlossen.";
          statusMessage.classList.remove("error");

          // Gr√ºnde
          const reasons = Array.isArray(data.reasons) ? data.reasons : [];
          if (reasons.length) {
            let html = "<ul>";
            for (const r of reasons) {
              html += "<li>" + String(r) + "</li>";
            }
            html += "</ul>";
            resultDiv.innerHTML = html;
          } else {
            resultDiv.innerHTML =
              "<p>Keine zus√§tzlichen Hinweise vorhanden.</p>";
          }
        } catch (err) {
          console.error(err);
          statusMessage.textContent =
            "Serverfehler ‚Äì Analyse derzeit nicht m√∂glich.";
          statusMessage.classList.add("error");
          scoreText.textContent = "KI-Wahrscheinlichkeit: ‚Äì";
          progressFill.style.width = "0%";
        } finally {
          setLoadingState(false);
        }
      };

      reader.readAsDataURL(file);
    });
  </script>
</body>
</html>
